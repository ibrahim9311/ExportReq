<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨Ø­Ø« Ø§Ù„Ø§Ø´ØªØ±Ø§Ø·Ø§Øª</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: "Cairo", sans-serif; background:#f7f8fa; margin:0; padding:20px; color:#222; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .controls { display:flex; gap:8px; align-items:center; }
    .btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; }
    .btn-primary { background:#00796b; color:#fff; }
    .btn-danger { background:#e53935; color:#fff; }
    input[type="text"] { padding:8px; border-radius:8px; border:1px solid #ccc; }
    .card { background:#fff; padding:12px; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .result { margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:8px; }
  </style>
</head>
<body>
  <div class="header">
    <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ø·Ø§Øª</h2>
    <div class="controls">
      <button id="to-reqs-btn" class="btn btn-primary">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ø·Ø§Øª</button>
      <button id="logout-btn" class="btn btn-danger">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; gap:8px; margin-bottom:12px;">
      <input id="countryInput" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆÙ„Ø© (Ø¬Ø²Ø¦ÙŠ Ø£Ùˆ ÙƒØ§Ù…Ù„)" />
      <input id="cropInput" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØµÙˆÙ„ (Ø¬Ø²Ø¦ÙŠ Ø£Ùˆ ÙƒØ§Ù…Ù„)" />
      <button id="searchBtn" class="btn btn-primary">Ø¨Ø­Ø«</button>
    </div>

    <div id="resultsArea">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø«.</div>
  </div>

<script>
  const SUPABASE_URL = "https://uulzslgyqygvtpfgeecr.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1bHpzbGd5cXlndnRwZmdlZWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NzM4ODEsImV4cCI6MjA3NTM0OTg4MX0.VLJ_R6aKKz39AvZphb0JGVspUpw--l2JNzrk5yuNwkQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const toReqsBtn = document.getElementById('to-reqs-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const searchBtn = document.getElementById('searchBtn');
  const resultsArea = document.getElementById('resultsArea');

  toReqsBtn.addEventListener('click', () => window.location.href = 'requirements.html');
  logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  });

  // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙ…Ù† ÙˆØ¬ÙˆØ¯ profile
  (async function checkAuth() {
    const { data } = await supabase.auth.getSession();
    const session = data?.session;
    if (!session) {
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§');
      window.location.href = 'login.html';
      return;
    }
    // ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ profile Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª: Ù„ÙƒÙ† RLS ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ profiles
  })();

  // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« â€” Ù†Ù‡Ø¬ Ø¢Ù…Ù†: Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ù† IDs Ù„Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„Ù…Ø­ØµÙˆÙ„ Ø«Ù… Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ø·Ø§Øª
  async function performSearch() {
    const countryText = document.getElementById('countryInput').value.trim();
    const cropText = document.getElementById('cropInput').value.trim();

    // Ø§Ø¬Ù„Ø¨ matching country ids
    let country_ids = null;
    let crop_ids = null;

    if (countryText) {
      const { data: countries, error } = await supabase.from('countries').select('id').ilike('name_ar', `%${countryText}%`);
      if (error) { console.error(error); resultsArea.innerHTML = '<p style="color:red">Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¯ÙˆÙ„.</p>'; return; }
      country_ids = (countries || []).map(c => c.id);
      if (country_ids.length === 0) { resultsArea.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆÙ„Ø© Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>'; return; }
    }

    if (cropText) {
      const { data: crops, error } = await supabase.from('crops').select('id').ilike('name_ar', `%${cropText}%`);
      if (error) { console.error(error); resultsArea.innerHTML = '<p style="color:red">Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø­Ø§ØµÙŠÙ„.</p>'; return; }
      crop_ids = (crops || []).map(c => c.id);
      if (crop_ids.length === 0) { resultsArea.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ØµÙŠÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>'; return; }
    }

    // Ø¨Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ù„Ø§Ù… export_requirements
    let q = supabase.from('export_requirements').select('id, short_summary, full_requirements, publication_number, publication_year, country_id, crop_id').order('created_at', { ascending: false }).limit(500);

    if (country_ids) q = q.in('country_id', country_ids);
    if (crop_ids) q = q.in('crop_id', crop_ids);

    const { data, error } = await q;
    if (error) { console.error(error); resultsArea.innerHTML = '<p style="color:red">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</p>'; return; }
    if (!data || data.length === 0) { resultsArea.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>'; return; }

    // Ù†Ø­ØªØ§Ø¬ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯ÙˆÙ„/Ø§Ù„Ù…Ø­Ø§ØµÙŠÙ„ => Ù†Ø¬Ù„Ø¨Ù‡Ø§ Ø¯ÙØ¹Ø© ÙˆÙ†Ø¨Ù†ÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const countryIdsNeeded = [...new Set(data.map(r => r.country_id).filter(Boolean))];
    const cropIdsNeeded = [...new Set(data.map(r => r.crop_id).filter(Boolean))];

    const [{ data: countries }, { data: crops }] = await Promise.all([
      countryIdsNeeded.length ? supabase.from('countries').select('id, name_ar').in('id', countryIdsNeeded) : Promise.resolve({ data: [] }),
      cropIdsNeeded.length ? supabase.from('crops').select('id, name_ar').in('id', cropIdsNeeded) : Promise.resolve({ data: [] })
    ]);

    const cMap = {};
    (countries || []).forEach(c => cMap[c.id] = c.name_ar);
    const crMap = {};
    (crops || []).forEach(c => crMap[c.id] = c.name_ar);

    // Ø¨Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    resultsArea.innerHTML = '';
    data.forEach(r => {
      const countryName = cMap[r.country_id] || '-';
      const cropName = crMap[r.crop_id] || '-';
      const shortS = r.short_summary || '-';
      const fullR = r.full_requirements || '-';
      const pubNum = r.publication_number || '-';
      const pubYear = r.publication_year || '-';

      const div = document.createElement('div');
      div.className = 'result';
      div.innerHTML = `<strong>${escapeHtml(shortS)}</strong><br>
                       <b>Ø§Ù„Ø¯ÙˆÙ„Ø©:</b> ${escapeHtml(countryName)} â€” <b>Ø§Ù„Ù…Ø­ØµÙˆÙ„:</b> ${escapeHtml(cropName)}<br>
                       <b>Ø±Ù‚Ù… Ø§Ù„Ù†Ø´Ø±:</b> ${escapeHtml(pubNum)} â€” <b>Ø§Ù„Ø³Ù†Ø©:</b> ${escapeHtml(pubYear)}<br>
                       <details><summary>Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø´ØªØ±Ø§Ø· Ø§Ù„ÙƒØ§Ù…Ù„</summary><div>${escapeHtml(fullR)}</div></details>`;
      resultsArea.appendChild(div);
    });
  }

  function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]);
  }

  searchBtn.addEventListener('click', performSearch);
</script>
</body>
</html>
