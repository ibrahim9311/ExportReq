<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>بحث الاشتراطات</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: "Cairo", sans-serif; background:#f7f8fa; margin:0; padding:20px; color:#222; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .controls { display:flex; gap:8px; align-items:center; }
    .btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; }
    .btn-primary { background:#00796b; color:#fff; }
    .btn-danger { background:#e53935; color:#fff; }
    input[type="text"] { padding:8px; border-radius:8px; border:1px solid #ccc; }
    .card { background:#fff; padding:12px; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .result { margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:8px; }
  </style>
</head>
<body>
  <div class="header">
    <h2>🔍 البحث في الاشتراطات</h2>
    <div class="controls">
      <button id="to-reqs-btn" class="btn btn-primary">📋 قائمة الاشتراطات</button>
      <button id="logout-btn" class="btn btn-danger">🚪 تسجيل الخروج</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; gap:8px; margin-bottom:12px;">
      <input id="countryInput" type="text" placeholder="اسم الدولة (جزئي أو كامل)" />
      <input id="cropInput" type="text" placeholder="اسم المحصول (جزئي أو كامل)" />
      <button id="searchBtn" class="btn btn-primary">بحث</button>
    </div>

    <div id="resultsArea">لا توجد نتائج بعد البحث.</div>
  </div>

<script>
  const SUPABASE_URL = "https://uulzslgyqygvtpfgeecr.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1bHpzbGd5cXlndnRwZmdlZWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NzM4ODEsImV4cCI6MjA3NTM0OTg4MX0.VLJ_R6aKKz39AvZphb0JGVspUpw--l2JNzrk5yuNwkQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const toReqsBtn = document.getElementById('to-reqs-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const searchBtn = document.getElementById('searchBtn');
  const resultsArea = document.getElementById('resultsArea');

  toReqsBtn.addEventListener('click', () => window.location.href = 'requirements.html');
  logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  });

  // تأكد من تسجيل الدخول ومن وجود profile
  (async function checkAuth() {
    const { data } = await supabase.auth.getSession();
    const session = data?.session;
    if (!session) {
      alert('الرجاء تسجيل الدخول أولًا');
      window.location.href = 'login.html';
      return;
    }
    // يمكن التحقق من وجود profile أيضاً إذا أردت: لكن RLS يجب أن يسمح بالقراءة للمستخدمين في profiles
  })();

  // تنفيذ البحث — نهج آمن: بحث أولاً عن IDs للدولة/المحصول ثم جلب الاشتراطات
  async function performSearch() {
    const countryText = document.getElementById('countryInput').value.trim();
    const cropText = document.getElementById('cropInput').value.trim();

    // اجلب matching country ids
    let country_ids = null;
    let crop_ids = null;

    if (countryText) {
      const { data: countries, error } = await supabase.from('countries').select('id').ilike('name_ar', `%${countryText}%`);
      if (error) { console.error(error); resultsArea.innerHTML = '<p style="color:red">خطأ أثناء البحث عن الدول.</p>'; return; }
      country_ids = (countries || []).map(c => c.id);
      if (country_ids.length === 0) { resultsArea.innerHTML = '<p>لا توجد دولة مطابقة.</p>'; return; }
    }

    if (cropText) {
      const { data: crops, error } = await supabase.from('crops').select('id').ilike('name_ar', `%${cropText}%`);
      if (error) { console.error(error); resultsArea.innerHTML = '<p style="color:red">خطأ أثناء البحث عن المحاصيل.</p>'; return; }
      crop_ids = (crops || []).map(c => c.id);
      if (crop_ids.length === 0) { resultsArea.innerHTML = '<p>لا توجد محاصيل مطابقة.</p>'; return; }
    }

    // بناء استعلام export_requirements
    let q = supabase.from('export_requirements').select('id, short_summary, full_requirements, publication_number, publication_year, country_id, crop_id').order('created_at', { ascending: false }).limit(500);

    if (country_ids) q = q.in('country_id', country_ids);
    if (crop_ids) q = q.in('crop_id', crop_ids);

    const { data, error } = await q;
    if (error) { console.error(error); resultsArea.innerHTML = '<p style="color:red">حدث خطأ أثناء تحميل النتائج.</p>'; return; }
    if (!data || data.length === 0) { resultsArea.innerHTML = '<p>لا توجد نتائج مطابقة.</p>'; return; }

    // نحتاج أسماء الدول/المحاصيل => نجلبها دفعة ونبني الخريطة
    const countryIdsNeeded = [...new Set(data.map(r => r.country_id).filter(Boolean))];
    const cropIdsNeeded = [...new Set(data.map(r => r.crop_id).filter(Boolean))];

    const [{ data: countries }, { data: crops }] = await Promise.all([
      countryIdsNeeded.length ? supabase.from('countries').select('id, name_ar').in('id', countryIdsNeeded) : Promise.resolve({ data: [] }),
      cropIdsNeeded.length ? supabase.from('crops').select('id, name_ar').in('id', cropIdsNeeded) : Promise.resolve({ data: [] })
    ]);

    const cMap = {};
    (countries || []).forEach(c => cMap[c.id] = c.name_ar);
    const crMap = {};
    (crops || []).forEach(c => crMap[c.id] = c.name_ar);

    // بنعرض النتائج
    resultsArea.innerHTML = '';
    data.forEach(r => {
      const countryName = cMap[r.country_id] || '-';
      const cropName = crMap[r.crop_id] || '-';
      const shortS = r.short_summary || '-';
      const fullR = r.full_requirements || '-';
      const pubNum = r.publication_number || '-';
      const pubYear = r.publication_year || '-';

      const div = document.createElement('div');
      div.className = 'result';
      div.innerHTML = `<strong>${escapeHtml(shortS)}</strong><br>
                       <b>الدولة:</b> ${escapeHtml(countryName)} — <b>المحصول:</b> ${escapeHtml(cropName)}<br>
                       <b>رقم النشر:</b> ${escapeHtml(pubNum)} — <b>السنة:</b> ${escapeHtml(pubYear)}<br>
                       <details><summary>عرض الاشتراط الكامل</summary><div>${escapeHtml(fullR)}</div></details>`;
      resultsArea.appendChild(div);
    });
  }

  function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]);
  }

  searchBtn.addEventListener('click', performSearch);
</script>
</body>
</html>
