<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ø·Ø§Øª</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Ø¨Ø³ÙŠØ· Ù…Ø¯Ù…Ø¬ Ù„Ù„ØªØ¬Ø±Ø¨Ø© â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ css/style.css Ù„Ø§Ø­Ù‚Ø§Ù‹ */
    body { font-family: "Cairo", sans-serif; background:#f5f7fa; margin:0; padding:20px; color:#222; }
    .header { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:16px; }
    .title { font-size:20px; color:#0b6b4a; }
    .btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-size:14px; }
    .btn-primary { background:#00796b; color:#fff; }
    .btn-danger { background:#e53935; color:#fff; }
    .btn-outline { background:#fff; border:1px solid #00796b; color:#00796b; }
    .controls { display:flex; gap:8px; align-items:center; }
    .filters { margin-bottom:12px; display:flex; gap:8px; align-items:center; }
    input[type="text"], select { padding:8px; border-radius:8px; border:1px solid #ccc; }
    .card { background:#fff; padding:12px; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:center; }
    th { background:#00796b; color:#fff; }
    .no-data { text-align:center; padding:12px; color:#666; }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ø·Ø§Øª</div>
    <div class="controls">
      <button id="to-search-btn" class="btn btn-outline">ğŸ” ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«</button>
      <button id="add-btn" class="btn btn-primary" style="display:none;">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ø·</button>
      <button id="logout-btn" class="btn btn-danger">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="card">
    <div class="filters">
      <input id="filterCountry" type="text" placeholder="ÙÙ„ØªØ± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø© (Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆÙ„Ø©)"/>
      <input id="filterCrop" type="text" placeholder="ÙÙ„ØªØ± Ø¨Ø§Ù„Ù…Ø­ØµÙˆÙ„ (Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØµÙˆÙ„)"/>
      <button id="filterBtn" class="btn btn-outline">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
      <button id="clearFilterBtn" class="btn">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
    </div>

    <div id="tableWrap">
      <table id="reqTable">
        <thead>
          <tr>
            <th>Ø§Ù„Ø¯ÙˆÙ„Ø©</th>
            <th>Ø§Ù„Ù…Ø­ØµÙˆÙ„</th>
            <th>Ø§Ù„Ø§Ø®ØªØµØ§Ø±</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù†Ø´Ø±</th>
            <th>Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø±</th>
          </tr>
        </thead>
        <tbody id="reqBody">
          <tr><td colspan="5" class="no-data">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯ Supabase â€” ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ ØªØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù‚ÙŠÙ…
  const SUPABASE_URL = "https://uulzslgyqygvtpfgeecr.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1bHpzbGd5cXlndnRwZmdlZWNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NzM4ODEsImV4cCI6MjA3NTM0OTg4MX0.VLJ_R6aKKz39AvZphb0JGVspUpw--l2JNzrk5yuNwkQ";
  const supabase = supabaseJs = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø©
  const toSearchBtn = document.getElementById('to-search-btn');
  const addBtn = document.getElementById('add-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const reqBody = document.getElementById('reqBody');
  const filterCountry = document.getElementById('filterCountry');
  const filterCrop = document.getElementById('filterCrop');
  const filterBtn = document.getElementById('filterBtn');
  const clearFilterBtn = document.getElementById('clearFilterBtn');

  // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø±
  toSearchBtn.addEventListener('click', () => window.location.href = 'search.html');
  logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  });
  addBtn.addEventListener('click', () => window.location.href = 'add-requirement.html');

  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯ (countries, crops) ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
  let countriesMap = {};
  let cropsMap = {};

  async function loadLookups() {
    // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„ ÙˆØ§Ù„Ù…Ø­Ø§ØµÙŠÙ„ (Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø³Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)
    const [{ data: countries, error: cErr }, { data: crops, error: crErr }] = await Promise.all([
      supabase.from('countries').select('id, name_ar'),
      supabase.from('crops').select('id, name_ar')
    ]);

    if (cErr || crErr) {
      console.error('Lookup load error', cErr || crErr);
      // Ù„ÙƒÙ†Ù‡ Ù„ÙŠØ³ Ù‚Ø§ØªÙ„Ø§Ù‹ â€” ØªØ§Ø¨Ø¹ Ø¨Ù€ empty maps
    }

    countries?.forEach(r => countriesMap[r.id] = r.name_ar);
    crops?.forEach(r => cropsMap[r.id] = r.name_ar);
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ø·Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙÙ„ØªØ±Ø©)
  async function loadRequirements(filter = {}) {
    reqBody.innerHTML = '<tr><td colspan="5" class="no-data">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';

    // Ù†Ø¬Ù„Ø¨ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù‚Ø© join Ù…ØªØ·Ù„Ø¨Ø©)
    let q = supabase.from('export_requirements').select('*').order('created_at', { ascending: false }).limit(1000);

    if (filter.country_ids && filter.country_ids.length) {
      q = q.in('country_id', filter.country_ids);
    }
    if (filter.crop_ids && filter.crop_ids.length) {
      q = q.in('crop_id', filter.crop_ids);
    }

    const { data, error } = await q;
    if (error) {
      console.error('loadRequirements error', error);
      reqBody.innerHTML = `<tr><td colspan="5" class="no-data">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>`;
      return;
    }

    if (!data || data.length === 0) {
      reqBody.innerHTML = `<tr><td colspan="5" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§Ø·Ø§Øª.</td></tr>`;
      return;
    }

    // Ø§Ø¨Ù†ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø³ØªØ¹ÙŠÙ†Ù‹Ø§ Ø¨Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù€ names
    reqBody.innerHTML = '';
    data.forEach(r => {
      const countryName = countriesMap[r.country_id] || (r.country_name || '-') ;
      const cropName = cropsMap[r.crop_id] || (r.crop_name || '-') ;
      const shortS = r.short_summary || (r.summary || '-') || '-';
      const pubNum = r.publication_number || '-';
      const pubYear = r.publication_year || '-';

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(countryName)}</td>
                      <td>${escapeHtml(cropName)}</td>
                      <td>${escapeHtml(shortS)}</td>
                      <td>${escapeHtml(pubNum)}</td>
                      <td>${escapeHtml(pubYear)}</td>`;
      reqBody.appendChild(tr);
    });
  }

  // ÙÙ„ØªØ±Ø© Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† matching country/crop names Ø«Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… IDs
  async function applyFilters() {
    const countryText = filterCountry.value.trim();
    const cropText = filterCrop.value.trim();

    let country_ids = [];
    let crop_ids = [];

    if (countryText) {
      const { data: countries, error } = await supabase.from('countries').select('id').ilike('name_ar', `%${countryText}%`);
      if (error) { console.error(error); }
      country_ids = (countries || []).map(c => c.id);
      if (country_ids.length === 0) {
        // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆÙ„Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© -> ØµÙÙˆÙ ÙØ§Ø±ØºØ©
        reqBody.innerHTML = `<tr><td colspan="5" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¯ÙˆÙ„Ø©.</td></tr>`;
        return;
      }
    }

    if (cropText) {
      const { data: crops, error } = await supabase.from('crops').select('id').ilike('name_ar', `%${cropText}%`);
      if (error) { console.error(error); }
      crop_ids = (crops || []).map(c => c.id);
      if (crop_ids.length === 0) {
        reqBody.innerHTML = `<tr><td colspan="5" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø­ØµÙˆÙ„.</td></tr>`;
        return;
      }
    }

    await loadRequirements({ country_ids, crop_ids });
  }

  // ÙØ­Øµ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ùˆ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ù†Ø§Ø³Ø¨Ø©
  async function checkUserAndInit() {
    const { data } = await supabase.auth.getSession();
    const session = data?.session;
    if (!session) {
      // Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:
      // window.location.href = 'login.html';
      // Ù„ÙƒÙ† Ù‡Ù†Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø­Ø³Ø¨ ØªØµÙ…ÙŠÙ…Ùƒ) â€” Ø³Ø£Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„:
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
      window.location.href = 'login.html';
      return;
    }

    // Ø¬Ù„Ø¨ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† profiles
    const userId = session.user.id;
    const { data: profile, error } = await supabase.from('profiles').select('role_id').eq('id', userId).maybeSingle();
    if (error) console.error('profile fetch error', error);

    if (profile && (profile.role_id === 1 || profile.role_id === 2)) {
      addBtn.style.display = 'inline-block';
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await loadLookups();
    await loadRequirements();
  }

  // Ø­Ù…Ø§ÙŠØ© ØµØºÙŠØ±Ø© Ù„Ø¹Ø±Ø¶ Ù†ØµÙˆØµ Ø¢Ù…Ù†Ø© ÙÙŠ HTML
  function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, function (m) {
      return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m];
    });
  }

  // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  filterBtn.addEventListener('click', applyFilters);
  clearFilterBtn.addEventListener('click', async () => {
    filterCountry.value = '';
    filterCrop.value = '';
    await loadRequirements();
  });

  // init
  checkUserAndInit();
</script>
</body>
</html>
